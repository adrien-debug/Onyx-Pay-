// Onyx Launch & Ops Platform - Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH & USERS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          String    @default("VIEWER") // ADMIN, PM, OPS, LEGAL, SALES, VIEWER
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tasksAssigned   Task[]      @relation("TaskAssignee")
  tasksCreated    Task[]      @relation("TaskCreator")
  comments        Comment[]
  decisions       Decision[]
  risks           Risk[]
  milestones      Milestone[] @relation("MilestoneOwner")

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  @@map("sessions")
}

// ============================================
// PROJECT MANAGEMENT
// ============================================

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  targetDate  DateTime?
  status      String   @default("TODO") // BACKLOG, TODO, IN_PROGRESS, BLOCKED, DONE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workstreams Workstream[]
  milestones  Milestone[]
  tasks       Task[]
  risks       Risk[]
  decisions   Decision[]

  @@map("projects")
}

model Workstream {
  id          String   @id @default(cuid())
  name        String
  description String?
  objectives  String?
  projectId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]
  milestones  Milestone[]
  risks       Risk[]

  @@map("workstreams")
}

model Milestone {
  id           String    @id @default(cuid())
  title        String
  description  String?
  targetDate   DateTime
  completedAt  DateTime?
  ownerId      String?
  projectId    String
  workstreamId String?
  order        Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  owner       User?       @relation("MilestoneOwner", fields: [ownerId], references: [id])
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workstream  Workstream? @relation(fields: [workstreamId], references: [id])
  checklist   MilestoneChecklistItem[]
  dependencies MilestoneDependency[] @relation("DependentMilestone")
  dependents   MilestoneDependency[] @relation("DependencyMilestone")

  @@map("milestones")
}

model MilestoneChecklistItem {
  id          String   @id @default(cuid())
  title       String
  completed   Boolean  @default(false)
  milestoneId String
  order       Int      @default(0)

  milestone   Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  @@map("milestone_checklist_items")
}

model MilestoneDependency {
  id           String @id @default(cuid())
  milestoneId  String
  dependsOnId  String

  milestone    Milestone @relation("DependentMilestone", fields: [milestoneId], references: [id], onDelete: Cascade)
  dependsOn    Milestone @relation("DependencyMilestone", fields: [dependsOnId], references: [id], onDelete: Cascade)

  @@unique([milestoneId, dependsOnId])
  @@map("milestone_dependencies")
}

model Task {
  id           String    @id @default(cuid())
  title        String
  description  String?
  status       String    @default("BACKLOG") // BACKLOG, TODO, IN_PROGRESS, BLOCKED, DONE
  priority     String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  dueDate      DateTime?
  completedAt  DateTime?
  tags         String?   // JSON string array
  projectId    String
  workstreamId String?
  assigneeId   String?
  creatorId    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workstream   Workstream? @relation(fields: [workstreamId], references: [id])
  assignee     User?       @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator      User?       @relation("TaskCreator", fields: [creatorId], references: [id])
  checklist    TaskChecklistItem[]
  comments     Comment[]
  attachments  Attachment[]

  @@map("tasks")
}

model TaskChecklistItem {
  id        String   @id @default(cuid())
  title     String
  completed Boolean  @default(false)
  taskId    String
  order     Int      @default(0)

  task      Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_checklist_items")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  taskId    String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task      Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author    User @relation(fields: [authorId], references: [id])

  @@map("comments")
}

model Attachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  type      String?
  size      Int?
  taskId    String
  createdAt DateTime @default(now())

  task      Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model Decision {
  id         String   @id @default(cuid())
  title      String
  rationale  String?
  outcome    String?
  decidedAt  DateTime @default(now())
  deciderId  String
  projectId  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  decider    User    @relation(fields: [deciderId], references: [id])
  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("decisions")
}

model Risk {
  id           String   @id @default(cuid())
  title        String
  description  String?
  probability  Int      @default(3) // 1-5
  impact       Int      @default(3) // 1-5
  mitigation   String?
  status       String   @default("TODO") // BACKLOG, TODO, IN_PROGRESS, BLOCKED, DONE
  projectId    String
  workstreamId String?
  ownerId      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workstream   Workstream? @relation(fields: [workstreamId], references: [id])
  owner        User?       @relation(fields: [ownerId], references: [id])

  @@map("risks")
}

// ============================================
// HARDWARE RESEARCH
// ============================================

model HardwareCandidate {
  id              String   @id @default(cuid())
  name            String
  brand           String?
  model           String?
  price           Float?
  currency        String   @default("USD")
  availability    String?
  specs           String?  // JSON string
  constraints     String?  // JSON string
  fieldNotes      String?
  score           Int?     // 1-10
  recommendation  String?  // PRIMARY, BACKUP, REJECTED
  status          String   @default("TODO")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bundles         BundleItem[]

  @@map("hardware_candidates")
}

model AccessoryDesign {
  id           String   @id @default(cuid())
  name         String
  type         String   // CASE, SUPPORT, CHARGER, OTHER
  description  String?
  materials    String?
  dimensions   String?
  branding     String?
  supplier     String?
  unitCost     Float?
  currency     String   @default("USD")
  leadTime     String?
  status       String   @default("TODO")
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  bundles      BundleItem[]

  @@map("accessory_designs")
}

model Bundle {
  id          String   @id @default(cuid())
  name        String
  description String?
  totalCost   Float?
  currency    String   @default("USD")
  isStandard  Boolean  @default(false)
  status      String   @default("TODO")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items       BundleItem[]

  @@map("bundles")
}

model BundleItem {
  id                  String  @id @default(cuid())
  bundleId            String
  hardwareCandidateId String?
  accessoryDesignId   String?
  quantity            Int     @default(1)
  notes               String?

  bundle              Bundle             @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  hardwareCandidate   HardwareCandidate? @relation(fields: [hardwareCandidateId], references: [id])
  accessoryDesign     AccessoryDesign?   @relation(fields: [accessoryDesignId], references: [id])

  @@map("bundle_items")
}

// ============================================
// LEGAL DOCUMENTS
// ============================================

model LegalDoc {
  id          String   @id @default(cuid())
  title       String
  type        String   // MSA, SLA, DPA, Terms, Privacy, etc.
  status      String   @default("DRAFT") // DRAFT, IN_REVIEW, APPROVED, SENT, SIGNED
  version     String   @default("1.0")
  content     String?
  fileUrl     String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("legal_docs")
}

// ============================================
// PRICING & PACKAGING
// ============================================

model PricingPlan {
  id             String   @id @default(cuid())
  name           String   // PILOT, PREMIUM, ENTERPRISE
  description    String?
  hardwareModel  String?
  setupFee       Float?
  monthlyFee     Float?
  transactionFee Float?
  feeType        String?  // PERCENTAGE, FIXED
  currency       String   @default("USD")
  inclusions     String?  // JSON string array
  slaLevel       String?
  supportHours   String?
  isActive       Boolean  @default(true)
  order          Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("pricing_plans")
}

// ============================================
// REWARD SYSTEM
// ============================================

model RewardRule {
  id          String   @id @default(cuid())
  name        String
  type        String   // PER_TX, PER_VOLUME, ADOPTION
  description String?
  formula     String?
  minThreshold Float?
  maxThreshold Float?
  capPerDay   Float?
  capPerMonth Float?
  conditions  String?
  isActive    Boolean  @default(true)
  testPeriod  String?
  testLocation String?
  testResults  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("reward_rules")
}

// ============================================
// CONTENT INGESTION
// ============================================

model ContentItem {
  id               String   @id @default(cuid())
  title            String?
  type             String   @default("OTHER") // WEBSITE, FAQ, PITCH, PRICING, OTHER
  rawHtml          String
  extractedJson    String?  // JSON string
  markdownProposal String?
  sourceUrl        String?
  tags             String?  // JSON string array
  status           String   @default("TODO")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("content_items")
}

// ============================================
// OPS KIT / RUNBOOKS
// ============================================

model Runbook {
  id          String   @id @default(cuid())
  title       String
  type        String   // venue_launch, incident, onboarding, etc.
  content     String   // Markdown content
  checklist   String?  // JSON string
  version     String   @default("1.0")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("runbooks")
}
